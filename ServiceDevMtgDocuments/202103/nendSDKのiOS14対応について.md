# nendSDK の　iOS 14対応について

## iOS 14の大きい変更点
- IDFAの取得がユーザーの許可制に
- SKAdNetwork 2.0の追加 (iOS 14.0以降)
  - 業界的には SKAdNetwork を SKAN と略すらしい

### IDFAの取得がユーザーの許可制に
- App Tracking Transparency フレームワークを使ってユーザーにトラッキングの許諾を得る必要が出た
- nendSDK では実装しない wikiで必要性と実装方法を案内するようにした

### SKAdNetwork 2.0の追加
- StoreKit フレームワークを使って広告を表示する機能がバージョンアップ
- 広告主が設定したコンバージョンを達成すると、アドネットワークに通達する機能
  - プライバシー保護の観点からcookieやIDFAの取得を制限する流れから、この機能を使うことを推奨している
- nendSDKはこの機能を使うことを採用

## SKAdNetwork 2.0 を使うために必要な情報
以下のパラメータをStoreKitに渡して広告を表示する
- ITunesItemIdentifier : 広告に表示されるアプリのAppStoreでのID
- AdNetworkIdentifier : Appleによって設定されてAd NetworkのID nendは eh6m2bh4zr.skadnetwork
- AdNetworkAttributionSignature : Ad Networkが生成した広告の署名
- AdNetworkNonce : Ad Networkが生成する広告インプレッション時に設定するランダムな値
- AdNetworkCampaignIdentifier : Ad Networkで任意に設定できるキャンペーンID (1-100まで)
- AdNetworkTimestamp : 広告配信時のタイムスタンプ
- AdNetworkVersion : 使用するSKAdNetworkのバージョン
- SourceAppStoreIdentifier : 広告を表示するアプリのAppStoreでのID (デバッグ時は0)

## nendSDKがやったこと

### 抽選リクエストのパラメータ追加
- SKAdNetworkが使える場合は抽選リクエストのパラメータに利用できるバージョンを追加
  - 開発当初の設定値は 2.0 のみ
  - SKAdNetworkが使える環境は iOS 14以降 かつ 実機のみ

### 抽選レスポンス受信〜AppStoreプロダクトのロード
- 抽選レスポンスに SKAdNetworkに関する情報が設定されていた場合、StoreKitを使用し広告プロダクトのロードを行う
  - ロードに失敗したらアプリ側へは広告ロードエラーを返す
  - 他所のサンプルでは広告表示の際にプロダクトのロードを行うものもあるが、広告をクリックしたのアプリがないという状況を避けたかった

### 広告クリック時にAppStoreの表示を行う
- 広告がクリックされたらStoreKitを使ってAppStoreの表示を行う
  - nendSDKがやっていることはここまで

## クリック後にStoreKitがやっていること
- AppStoreの情報を表示する
  - 未インストールの場合は インストール ボタンが表示される
  - インストール済みの場合は 開く ボタンが表示される
  - 過去にインストールしたが削除済みの場合は ダウンロード アイコンが表示される
- 上記のうち初回インストールと再インストールの場合はコンバージョン扱いとなる
  - StoreKitで管理しているDBにコンバージョンの情報が保存される
    - 広告プロダクトロード時のパラメータに不備があるとコンソールにログが出力される
  - インストールされたアプリが起動した 24時間後に、Ad Networkにポストバックされる
  - デバッグ用アプリでSKAdNetwork検証用プロファイルをインストールしていれば 10分ほどでポストバックされる

## SKAdNetwork 2.2
- iOS 14.5 から SKAdNetwork 2.2がリリースされ、Appleはそちらを利用することを推奨している

### SKAdNetwork 2.2 の追加機能
- view-through を計測できるようになった
  - 広告の表示＆表示終了をStoreKitに渡せるようになった
  - view-through が発生していれば、その後AppStore等の別アプリからコンバージョン達成の際にポストバックされる（はず 問題があり現在検証できていない）
  - インプレッションは３秒以上行われなければ計測されない

### view-through はいつ発生するか
- Appleのドキュメントでは、インプレッションの開始とインプレッションの完了を以て view-through としている
  - 全画面の動画広告に関しては 広告の表示開始＝インプレッション開始、広告のクローズ＝インプレッション完了 として扱っている
  - 動画ネイティブは、広告の表示開始＝インプレッション開始、動画が再生されて３秒後＝インプレッション完了 として扱っている
    - 本来は広告の表示が完了したら なので正しい使い方ではないかもしれないが、広告を視聴したということで計測することとした
  - 静止画の広告に関してはview-throughの計測は行っていない
    - 広告の表示は行ったが、画面外にスクロールされた場合 広告がどの程度の期間画面上に存在していたかを計測する実装を追加で行う必要がある
    - 開発の規模が大きいこと、大量に広告がロードされている場合の負荷が計り知れないので実装は保留している

### ~~SKAdNetwork 2.2 の検証が遅れている理由~~ ←解消されたのでこの話は発表しない
- ~~AppleにnendをAdNetwork登録する際に秘密鍵と公開鍵を登録する必要がある~~
  - ~~SKAdNetwork 2.0 時代は、prime192v1 curve を 署名生成に使用していた~~
  - ~~SKAdNetwork 2.1 がリリースされた際、Appleのドキュメント上ではprime256v1 curveを使うよう記述が変更されていた~~
  - ~~Appleに既存の鍵が使えるか問い合わせたところ、すでにAdNetwork登録されているので改めて作り直す必要はないと回答があった~~
  - ~~SKAdNetwork 2.2 がリリースされた際にもAppleに同様の問い合わせをしたところ、同様の内容の回答であった~~
  - ~~nend側のSKAdNetwork 2.2対応が進み、コンバージョンのテストをするが、ポストバックされない状態が続く~~
  - ~~改めて、SKAdNetwork 2.2 はprime192v1 curveで生成された鍵で問題ないかを尋ねたところ、SKAdNetwork 2.2, 2.0共にprime256v1を使用する必要があると回答~~
  - ~~現在prime256v1 curveで鍵を再生成し、Appleの登録待ち状態~~
  - ~~Appleから鍵の登録が完了したと通知がきた~~
  - ~~しかしSKAdNetwork 2.2でポストバックが行われない問題は解決しなかった~~
  - ~~その後、nendのサーバーサイドで署名の生成方法が誤っていたことが判明~~
    - ~~修正を行ったところポストバックが正常に行われた~~

## リリース時期について
- iOS 14.5の正式版またはRelease Candidateがリリースされた後に行う
  - beta版はバージョン毎に動作が変更される為、正式リリース版かそれに近い内容のバージョンで最終確認を行う
