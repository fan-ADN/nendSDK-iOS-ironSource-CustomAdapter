# コードレビューについて

## コードレビューとは

https://ja.wikipedia.org/wiki/コードレビュー  
コードレビュー（英: Code review）は、ソフトウェア開発工程で見過ごされた誤りを検出・修正することを目的としてソースコードの体系的な検査（査読）を行う作業のこと。

要は**複数の人でバグがないかをチェックする作業。**

サービス開発部では、GitHubのプルリクエスト上でコードレビューを実施している。

### プルリクエストの流れのイメージ

- 修正内容を記述したIssueの作成
![issue](https://user-images.githubusercontent.com/9563320/53868448-6d258600-4039-11e9-97d3-4bfe29acc85b.png)

- プルリクエストによるレビュー依頼
![pullrequest](https://user-images.githubusercontent.com/9563320/53868531-9b0aca80-4039-11e9-90fe-bede8e5b528f.png)

- プルリクエスト上での指摘
![feedback](https://user-images.githubusercontent.com/9563320/53868568-aeb63100-4039-11e9-8cc1-37b0c0348b53.png)

- 指摘の修正 〜 レビュー終了＆プルリクエストクローズ
![close](https://user-images.githubusercontent.com/9563320/53868604-c2619780-4039-11e9-9dd0-9d19500f4f4e.png)


## コードレビューのやり方

<!-- diffでレビューするやり方 -->
レビュー対象の修正部分が正しいかを確認する  
GitHubのプルリクエストの`Files changed`を確認してレビュー


<!-- PRのサンプル画像 -->
![GitHub Files changed](https://user-images.githubusercontent.com/9563320/53868665-df966600-4039-11e9-8694-445d73f41bee.png)

その他、必要に応じてツール等を利用する  
(例：デバッガで動作確認しながらコードレビューを行いたい場合にXcodeのVersion Editorを利用)
<!-- Xcodeのサンプル -->
![Xcode Diff](https://user-images.githubusercontent.com/9563320/53868721-fdfc6180-4039-11e9-9255-c4a837645489.png)

### コードレビューの観点

以下の内容に注意しレビューを行う

- 挙動（意図どおり動作するか）
- バグ
- 可読性
- テスト
- パフォーマンス
- 設計



<!-- ### コードレビューを効率化するちょっとした工夫

https://fancsdev.qiita.com/yotsak83/items/7da33bbf23e1370bb672 -->
<!-- 他で書かれている内容なのと、コードレビューの心得 でまとまっているので省略 -->

## コードレビューの際に気をつけること

https://qiita.com/awakia/items/8344ba751426e386e0f5

### レビュイーとして大切なこと

ここでは、コードを書いてPull Requestを送る際に意識しておくと良いことを書いておきます。

1. できるだけ小さい単位でPull Requestを送る
1. 何故やったかを書く
1. テストを書く

#### できるだけ小さい単位でPull Requestを送る

変更が1000行を超えるようなものをしっかりレビューするのなんてほぼ不可能です。  
できるだけ、細かく機能を分け、小さい単位でRequestを送るようにしましょう。  
masterや開発の本流ブランチに直接マージしては困るものも、トピックブランチを作ってそのトピックブランチへのMergeリクエストを送るようにすればこれが可能です。  
細かくRequestを送ることが難しい場合は、早めにPull Requestを作成し、随時見てもらうという方法があります。[WIP](Work in Progressの略)をタイトルの頭につけて、完成前のある程度中身が見えてきた段階でPull Requestを送るとよいです([*](#DraftPullRequests))。

<a name="DraftPullRequests"></a>(* GitHubに[draft pull requests](https://github.com/fan-ADN/nendSDK-Document-Private/pull/10)でプルリクエストを作成することができ、
GitHubの機能を使用してWIPのプルリクエストを作成することもできる。)

#### 何故やったかを書く

何をやったかはcommitにも大体書かれますし、書かれていなくてもコードを読めばわかるはずですが、何故そのRequestが必要だったかは書かないとわかりません。  
すごく自明で無い限り書くようにしましょう。  
対応する適切なIssueがある場合は、そのIssueに紐付ければそれで終わることもあります。


#### テストを書く

「レビューをしてもらってるわけだし、挙動があっているかはレビュアーに確認してもらおう」というような事は、程度の差はあれ思ってしまったりします。  
でも、出したコードにバグがあった時、レビュアーにももちろん責任はありますが、基本的には、やはりコードを書いた人の責任です。  
レビュアーに確認してもらいたいような部分は積極的にテストを書くようにしましょう。レビュアーもテストのレビューのほうがしやすいです。  
特に、モデルに相当する部分の単体テスト、サービスのコアとなるような重要な機能のテストは書くようにすると良いです。([*](#WriteTest))

<a name="WriteTest"></a>(* 単体テストはカバレッジ100%で実施してください。重要な機能のテストは、必要であれば I/Fからの結合テストを実施してください。)

### レビュアーとして大切なこと

1. レビューする時
1. 気をつけて見るポイント

#### レビューする時

- diffとして見えている問題の指摘ができる  
  - コーディング規約に従っていない、スペルミス/タイポ、名前がわかりにくい、if 文の条件が間違っているなど
- diffとして見えていない問題の指摘ができる  
  (Requestに現れていないコード部で起こる問題)
  - 変更しようと思っていない部分への副作用の考慮
  - 将来的に生じる問題の予測

#### 気をつけて見るポイント

##### バグを生みやすいところを重点的に見る

- 境界条件でうまく動くか確認
  - 特に要素がない時 (0, nil etc.) もエラーが出なく、表示的にも問題ないか
- テストがちゃんと問題が起こっているとき、きちんとFailするテストになっているか
- 名前の付け方が悪くて誤解を生みやすいものがないか
- 違う意味なのに、同じ名前で使われている変数はないか
- 結果を返し忘れたりしてしまうコードパスがないか
- 1つのメソッドにやたらとif文のネストある構成になっていないか
  - if文のネストが多いと網羅性のあるテストも書きにくいので大抵設計を見なおしたほうが良いです
- バグを生みやすいコードがないか、脳内ストックから引き出す
  - 例えば、rubyでif文以外ではsaveでなくsave!を使っておく等
  - 普段からそういうコードの脳内ストックを増やすようにしましょう！
- 並列処理に気をつける
  - 並列処理によるバグはタイミングによって発生するため、 デバッグが非常に困難
  - 並列処理が実行される場合は、意識をしてテストが書かれているかを確認する

##### バグや設計変更があった時に、大変になるところを重点的に見る

- メールの送信など送ってしまったら取り返しがつかないものはきちんと試してみる
- セキュリティの問題を抱えやすい場所は注意する
  - ユーザー入力を埋め込んでる場所など (XSS/SQL Injection etc)
- **サービスの根本的な価値や、お金につながるような変更は死ぬ気で見る**

## コードレビューの心得

https://fancsdev.qiita.com/ymishiba/items/00fda280ec4a44c503af

<!-- 各内容についてざっくり -->
### 1.コメントに優先順位を付けましょう

- [MUST/SHOULD/IMO/nits]
- 意思疎通が図りやすくなります。

#### 優先度を表す略語
- MUST : **必ず** 直すべき  
- SHOULD : 直すべき  
- IMO : 自分なら直すけどどう? 緩やかな指摘(In my opinion)  
- nits : 細かい指摘(nitpick)  

### 2.対応の優先度を決めましょう
- 様々な指摘を受けて混乱することもあるでしょう。しかし決めるのはあなたです。**時間は有限です。**  
- MUST以外は最悪やらなくてもいいはずです。

### 3.わからない指摘は聞きましょう
- 知らないことを考えたって答えは出ないものです。
- 指摘者・リーダー・マネージャー・隣の席の人、**聞く人は沢山います。**

### 4.PRの作り方を工夫しましょう
- 大きなPRにはどうしたって沢山の指摘がついてしまうものです。
- issueが大きいようであればPRの分割方法を誰かに相談するのもいいでしょう。
- 一部分だけ実装したPRをあげれば以降の方針のブレも少なくなるでしょう。
- 指摘が入りすぎたらPRを作り直すことも視野にいれましょう。

### 5.最後に
- レビューは意見がぶつかる場なのでどうしたってストレスがたまると思います。
- そこで疲弊せずにより良いプロダクトを作っていけるといいですね。
